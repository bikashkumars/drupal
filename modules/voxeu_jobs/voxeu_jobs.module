<?php

/**
 * Define url of web service.
 */
if (!defined('URL_SERVICE')) { 
  define('URL_SERVICE','https://backend.econjobmarket.org/rest/zz_cea/XML/Table/myads');
}

if (!defined('URL_SERVICE_IMG')) {
  define('URL_SERVICE_IMG','http://backend.econjobmarket.org/ejm_setup/readgif'); 
}

if (!defined('URL_LINK_APPLY')) {
  define('URL_LINK_APPLY','http://econjobmarket.org/Apply/PosApp.php?posid='); 
}

if (!defined('URL_PERMALINK')) {
  define('URL_PERMALINK','http://economics.ca/cgi/ejm?id='); 
}

/**
 * Implements hook_menu().
 */
function voxeu_jobs_menu() {
  return array(
    'job/%' => array(
      'title' => 'EconJobMarket Advertisements',
      'access callback' => TRUE,
      'page callback' => 'job_detail',
      'page arguments' => array(1),
      'type' => MENU_NORMAL_ITEM,
    ),
  );
}

/**
 * Implements hook_block().
 */
function voxeu_jobs_block($op = 'list', $delta = 'filter', $edit = array()) {
  // The $op parameter determines what piece of information is being requested.
  switch ($op) {
    case 'list':
      // If $op is "list", we just need to return a list of block descriptions.
      // This is used to provide a list of possible blocks to the administrator;
      // end users will not see these descriptions.
      $blocks['filter'] = array(
        'info' => t('The filter form'),
      );
      return $blocks;
    case 'configure':
      // If $op is "configure", we need to provide the administrator with a
      // configuration form. The $delta parameter tells us which block is being
      // configured. In this example, we'll allow the administrator to customize
      // the text of the first block.
    case 'save':
      // If $op is "save", we need to save settings from the configuration form.
      // Since the first block is the only one that allows configuration, we
      // need to check $delta to make sure we only save it.
    case 'view':
      // If $op is "view", then we need to generate the block for display
      // purposes. The $delta parameter tells us which block is being requested.
      switch ($delta) {
        case 'filter':
          // The subject is displayed at the top of the block. Note that it
          // should be passed through t() for translation.
          $block['subject'] = t('Filter');
          // The content of the block is typically generated by calling a custom
          // function.
          $block['content'] = drupal_get_form('voxeu_jobs_form');
          break;
      }
      return $block;
  }
}

/**
 * Implements hook_theme().
 */
function voxeu_jobs_theme() {
  return array(
    'filter_result' => array(
      'arguments' => array('datas' => NULL),
      'template' => 'templates/filter_result',
    ),
    'job_detail' => array(
      'arguments' => array('myads' => NULL),
      'template' => 'templates/job_detail',
    ),
    'filter_form' => array(
      'arguments' => array('form' => array()),
      'template' => 'templates/filter_form',
    )
  );
}

function voxeu_jobs_form($form_state) {
  $form = array();
  $options1 = array(
    0 => '--please select--',
    'ALL' => 'all',
    17 => 'Any field (8)',
    16 => 'Behavioral Economics (2)',
    21 => 'Business Economics (5)',
    22 => 'Computational Economics (1)',
    1 => 'Development; Growth (3)', 
    2 => 'Econometrics (5)',
    3 => 'Economic History (1)',
    4 => 'Environmental; Ag. Econ (4)',
    5 => 'Experimental Economics (4)',
    6 => 'Finance (4)', 
    20 => 'Health; Education; Welfare (4)',
    7 => 'Industrial Organization (2)',
    26 => 'Insurance (1)',
    8 => 'International Finance/Macro (3)',
    9 => 'International Trade (2)',
    10 => 'Labor; Demographic Econ (1)',
    11 => 'Law and Economics (1)',
    12 => 'Macroeconomics; Monetary (7)',
    27 => 'Management, General (1)',
    30 => 'Marketing (1)',
    13 => 'Microeconomics (6)',
    18 => 'Other (1)',
    14 => 'Public Economics (2)',
    15 => 'Theory (1)',
    19 => 'Urban; Rural; Regional Econ (1)',
  );
  
  $form['categories'] = array(
    '#type' => 'select',
    '#title' => t('Area Categories'),
    '#options' => $options1,
    '#default_value' => 0,
    '#title_display' => 'none',
  );
  
  $options2 = array(
    0 => '--please select--',
    'ALL' => 'all',
    'Assistant Professor' => 'Assistant Professor (12)',
    'Full Professor' => 'Full Professor (2)',
    'Assistant or Associate Professor' => 'Assistant or Associate Professor (2)',
    'Assistant, Associate or Full Professor' => 'Assistant, Associate or Full Professor (2)', 
    'Professor Any Level' => 'Professor Any Level (2)',
    'Tenured Professor' => 'Tenured Professor (3)',
    'Untenured Professor' => 'Untenured Professor (1)',
    'Visiting Professor/Lecturer/Instructor' => 'Visiting Professor/Lecturer/Instructor (2)',
    'Lecturer' => 'Lecturer (3)', 
    'Other Non-Academic' => 'Other Non-Academic (4)',
  );
  
  
  $form['types'] = array(
    '#type' => 'select',
    '#title' => t('Position Types'),
    '#options' => $options2,
    '#default_value' => 0,
    '#title_display' => 'none',
  );
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Search'),
  );
  
  if (!empty($form_state['result'])) {
    $form['table'] = array(
      '#markup' => theme('filter_result', array('datas' => $form_state['result'])),
    );
  }
  
  $form['#theme'] = 'filter_form';
  
  return $form;
}

function job_form_submit(&$form, &$form_state) {
  $values = $form_state['values'];
  if ($values['categories'] && $values['types']) {
    $response = call_webservice(URL_SERVICE, 'text/xml');
    $data = $response->data;
    $xml = simplexml_load_string($data);
    $cid = $values['categories'];
    $type = $values['types'];
    $form_state['result'] = array();
    foreach ($xml as $myads) {
      if ($cid == 'ALL' && $type == 'ALL') {
        $form_state['result'][] = array(
          'title' => (string)$myads->adtitle,
          'posid' => (string)$myads->posid,
          'shortname' => (string)$myads->shortname,
        );
        $form_state['rebuild'] = TRUE;
      } elseif ($cid == strtoupper('all') && $type != strtoupper('all')) {
        $pos_type = (string)$myads->position_type;
        if ($type == $pos_type) {
          $form_state['result'][] = array(
            'title' => (string)$myads->adtitle,
            'posid' => (string)$myads->posid,
            'shortname' => (string)$myads->shortname,
          );
          $form_state['rebuild'] = TRUE;
        }
      } elseif ($cid != strtoupper('all') && $type == strtoupper('all')) {
        $categories = explode(',', (string)$myads->categories);
        $pos_type = (string)$myads->position_type;
        if (in_array($cid, $categories)) {
          $form_state['result'][] = array(
            'title' => (string)$myads->adtitle,
            'posid' => (string)$myads->posid,
            'shortname' => (string)$myads->shortname,
          );
          $form_state['rebuild'] = TRUE;
        }
      } else {
        $categories = explode(',', (string)$myads->categories);
        $pos_type = (string)$myads->position_type;
        if (in_array($cid, $categories) && $type == $pos_type) {
          $form_state['result'][] = array(
            'title' => (string)$myads->adtitle,
            'posid' => (string)$myads->posid,
            'shortname' => (string)$myads->shortname,
          );
          $form_state['rebuild'] = TRUE;
        }
      }
    }
  }
}

/**
 * Get data from Web serice.
 * 
 * @param string $url url of service
 * @param string $content_type Type on header
 */
function call_webservice($url = NULL, $content_type = NULL) {
  $options = array(
    'method' => 'POST',
    'headers' => array(
      'Content-type' => $content_type,
      'Authorization' => 'Basic Y2VhOkw4NGxEcnpabg==',
    )
  );
  return drupal_http_request($url, $options);
}

function job_detail($posid) {
  $html = '';
  $response = call_webservice(URL_SERVICE, 'text/xml');
  $data = $response->data;
  $xml = simplexml_load_string($data);
  foreach ($xml as $myads) {
    if ((string)$myads->posid == $posid) {
      $html .= theme('job_detail', array('myads' => $myads));
      break;
    }
  }
  return $html;
}
